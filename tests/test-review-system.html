<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .rating-stars {
            font-size: 1.5rem;
        }
        .rating-star {
            cursor: pointer;
            margin-right: 0.25rem;
        }
        .rating-star:hover {
            transform: scale(1.1);
        }
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">üîç Review System Test</h1>
        
        <!-- Test 1: Submit Review -->
        <div class="test-section">
            <h3>Test 1: Submit Review</h3>
            <p>Test the review submission functionality for a completed booking.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Booking ID</label>
                        <input type="number" class="form-control" id="bookingId" placeholder="Enter booking ID">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rating (1-5)</label>
                        <div class="rating-stars">
                            <i class="fas fa-star rating-star text-muted" data-rating="1"></i>
                            <i class="fas fa-star rating-star text-muted" data-rating="2"></i>
                            <i class="fas fa-star rating-star text-muted" data-rating="3"></i>
                            <i class="fas fa-star rating-star text-muted" data-rating="4"></i>
                            <i class="fas fa-star rating-star text-muted" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="selectedRating" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                        <textarea class="form-control" id="reviewComment" rows="3" placeholder="Share your experience..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                </div>
                <div class="col-md-6">
                    <div id="reviewResult"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 2: Get Technician Ratings -->
        <div class="test-section">
            <h3>Test 2: Get Technician Ratings</h3>
            <p>Test retrieving technician ratings and reviews.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Technician ID</label>
                        <input type="number" class="form-control" id="technicianId" placeholder="Enter technician ID">
                    </div>
                    <button class="btn btn-info" onclick="getTechnicianRatings()">Get Ratings</button>
                </div>
                <div class="col-md-6">
                    <div id="technicianResult"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 3: Get Shop Ratings -->
        <div class="test-section">
            <h3>Test 3: Get Shop Ratings</h3>
            <p>Test retrieving shop ratings and reviews.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Shop ID</label>
                        <input type="number" class="form-control" id="shopId" placeholder="Enter shop ID">
                    </div>
                    <button class="btn btn-warning" onclick="getShopRatings()">Get Ratings</button>
                </div>
                <div class="col-md-6">
                    <div id="shopResult"></div>
                </div>
            </div>
        </div>
        
        <!-- Test 4: Database Schema Check -->
        <div class="test-section">
            <h3>Test 4: Database Schema Check</h3>
            <p>Verify that all required tables and constraints exist.</p>
            <button class="btn btn-secondary" onclick="checkDatabaseSchema()">Check Schema</button>
            <div id="schemaResult" class="mt-3"></div>
        </div>
        
        <!-- Test Results Summary -->
        <div class="test-section">
            <h3>Test Results Summary</h3>
            <div id="testSummary">
                <p class="text-muted">Run tests to see results here.</p>
            </div>
        </div>
    </div>

    <script>
        let testResults = {
            submitReview: null,
            getTechnicianRatings: null,
            getShopRatings: null,
            checkSchema: null
        };

        // Initialize star rating
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    setRating(rating);
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });
            
            document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                const currentRating = parseInt(document.getElementById('selectedRating').value);
                highlightStars(currentRating);
            });
        });

        function setRating(rating) {
            document.getElementById('selectedRating').value = rating;
            highlightStars(rating);
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.className = 'fas fa-star rating-star text-warning';
                } else {
                    star.className = 'fas fa-star rating-star text-muted';
                }
            });
        }

        async function submitReview() {
            const bookingId = document.getElementById('bookingId').value;
            const rating = parseInt(document.getElementById('selectedRating').value);
            const comment = document.getElementById('reviewComment').value;
            
            if (!bookingId || !rating) {
                showResult('reviewResult', 'Please enter booking ID and select rating', 'error');
                return;
            }
            
            try {
                const response = await fetch('../backend/api/submit-review.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        booking_id: bookingId,
                        rating: rating,
                        comment: comment
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('reviewResult', `Review submitted successfully!<br>Technician: ${data.technician_name || 'N/A'}`, 'success');
                    testResults.submitReview = 'success';
                } else {
                    showResult('reviewResult', `Error: ${data.error}`, 'error');
                    testResults.submitReview = 'error';
                }
            } catch (error) {
                showResult('reviewResult', `Network error: ${error.message}`, 'error');
                testResults.submitReview = 'error';
            }
            
            updateTestSummary();
        }

        async function getTechnicianRatings() {
            const technicianId = document.getElementById('technicianId').value;
            
            if (!technicianId) {
                showResult('technicianResult', 'Please enter technician ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`../backend/api/get-ratings.php?type=technician&id=${technicianId}`);
                const data = await response.json();
                
                if (data.success) {
                    const rating = data.rating;
                    const reviews = data.recent_reviews;
                    let html = `
                        <div class="test-result test-success">
                            <h5>${data.technician.name}</h5>
                            <p><strong>Shop:</strong> ${data.technician.shop_name}</p>
                            <p><strong>Average Rating:</strong> ${rating.average_rating}/5 (${rating.total_reviews} reviews)</p>
                    `;
                    
                    if (reviews.length > 0) {
                        html += '<h6>Recent Reviews:</h6><ul>';
                        reviews.forEach(review => {
                            html += `<li>${review.rating}/5 - ${review.comment || 'No comment'} (${review.customer_name})</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div>';
                    showResult('technicianResult', html, 'success');
                    testResults.getTechnicianRatings = 'success';
                } else {
                    showResult('technicianResult', `Error: ${data.error}`, 'error');
                    testResults.getTechnicianRatings = 'error';
                }
            } catch (error) {
                showResult('technicianResult', `Network error: ${error.message}`, 'error');
                testResults.getTechnicianRatings = 'error';
            }
            
            updateTestSummary();
        }

        async function getShopRatings() {
            const shopId = document.getElementById('shopId').value;
            
            if (!shopId) {
                showResult('shopResult', 'Please enter shop ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`../backend/api/get-ratings.php?type=shop&id=${shopId}`);
                const data = await response.json();
                
                if (data.success) {
                    const rating = data.rating;
                    const reviews = data.recent_reviews;
                    let html = `
                        <div class="test-result test-success">
                            <h5>${data.shop.name}</h5>
                            <p><strong>Address:</strong> ${data.shop.address}</p>
                            <p><strong>Average Rating:</strong> ${rating.average_rating}/5 (${rating.total_reviews} reviews)</p>
                    `;
                    
                    if (reviews.length > 0) {
                        html += '<h6>Recent Reviews:</h6><ul>';
                        reviews.forEach(review => {
                            html += `<li>${review.rating}/5 - ${review.comment || 'No comment'} (${review.customer_name}) - Tech: ${review.technician_name || 'N/A'}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div>';
                    showResult('shopResult', html, 'success');
                    testResults.getShopRatings = 'success';
                } else {
                    showResult('shopResult', `Error: ${data.error}`, 'error');
                    testResults.getShopRatings = 'error';
                }
            } catch (error) {
                showResult('shopResult', `Network error: ${error.message}`, 'error');
                testResults.getShopRatings = 'error';
            }
            
            updateTestSummary();
        }

        async function checkDatabaseSchema() {
            try {
                // This would require a separate API endpoint to check schema
                // For now, we'll just show a placeholder
                showResult('schemaResult', 'Schema check would require additional API endpoint. Migration script should be run manually.', 'info');
                testResults.checkSchema = 'info';
            } catch (error) {
                showResult('schemaResult', `Error: ${error.message}`, 'error');
                testResults.checkSchema = 'error';
            }
            
            updateTestSummary();
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'test-success' : 
                            type === 'error' ? 'test-error' : 'test-info';
            element.innerHTML = `<div class="test-result ${className}">${message}</div>`;
        }

        function updateTestSummary() {
            const summary = document.getElementById('testSummary');
            let html = '<h5>Test Results:</h5><ul>';
            
            Object.keys(testResults).forEach(test => {
                if (testResults[test] !== null) {
                    const status = testResults[test] === 'success' ? '‚úÖ' : 
                                 testResults[test] === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                    const testName = test.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    html += `<li>${status} ${testName}: ${testResults[test]}</li>`;
                }
            });
            
            html += '</ul>';
            summary.innerHTML = html;
        }
    </script>
</body>
</html>
