<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Booking System - API Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section { border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .success { background-color: #d1e7dd; }
        .error { background-color: #f8d7da; }
        .code-block { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .step-indicator { font-weight: bold; color: #0d6efd; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4">üß™ Enhanced Booking System - API Tester</h1>
        <p class="lead">Test the complete booking workflow step by step</p>

        <!-- Authentication Note -->
        <div class="alert alert-info">
            <h5>‚ö†Ô∏è Prerequisites:</h5>
            <ul class="mb-0">
                <li>Make sure you're logged in as a customer in another tab</li>
                <li>Have at least one approved shop with services</li>
                <li>Have the shop owner logged in to test diagnosis</li>
            </ul>
        </div>

        <!-- Step 1: Create Booking -->
        <div class="test-section">
            <h3 class="step-indicator">Step 1: Create Booking</h3>
            <p>Customer submits a device for repair with details and optional photo.</p>
            
            <form id="createBookingForm">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Shop Owner ID</label>
                        <input type="number" class="form-control" id="shopOwnerId" value="1" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Service</label>
                        <input type="text" class="form-control" id="service" value="Screen Repair" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Device Type</label>
                        <input type="text" class="form-control" id="deviceType" value="iPhone 13 Pro" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Date (YYYY-MM-DD)</label>
                        <input type="date" class="form-control" id="bookingDate" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Time Slot (HH:MM)</label>
                        <input type="time" class="form-control" id="timeSlot" value="10:00" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Device Photo (Optional)</label>
                        <input type="file" class="form-control" id="devicePhoto" accept="image/*">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Issue Description</label>
                        <textarea class="form-control" id="issueDescription" rows="3" required>Screen is cracked and touch is not responding in the top right corner. Need urgent repair.</textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Booking</button>
            </form>
            
            <div id="step1Result" class="mt-3"></div>
        </div>

        <!-- Step 2: Provide Diagnosis -->
        <div class="test-section">
            <h3 class="step-indicator">Step 2: Shop Provides Diagnosis</h3>
            <p>Shop owner reviews the device and provides a quotation.</p>
            
            <form id="diagnosisForm">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Booking ID</label>
                        <input type="number" class="form-control" id="diagBookingId" placeholder="From Step 1" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estimated Cost (‚Ç±)</label>
                        <input type="number" class="form-control" id="estimatedCost" value="2500" step="0.01" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estimated Days</label>
                        <input type="number" class="form-control" id="estimatedDays" value="3" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Diagnostic Notes</label>
                        <textarea class="form-control" id="diagnosticNotes" rows="3" required>Screen replacement needed. LCD panel is damaged. Will also clean internal components and test all functionality.</textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning">Send Diagnosis</button>
            </form>
            
            <div id="step2Result" class="mt-3"></div>
        </div>

        <!-- Step 3: Customer Confirmation -->
        <div class="test-section">
            <h3 class="step-indicator">Step 3: Customer Confirms/Cancels</h3>
            <p>Customer reviews the quotation and decides to confirm or cancel.</p>
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Booking ID</label>
                    <input type="number" class="form-control" id="confirmBookingId" placeholder="From Step 1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cancellation Reason (if cancelling)</label>
                    <input type="text" class="form-control" id="cancelReason" placeholder="e.g., Price too high">
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="confirmBooking()">‚úì Confirm Booking</button>
                <button class="btn btn-danger" onclick="cancelBooking()">‚úó Cancel Booking</button>
            </div>
            
            <div id="step3Result" class="mt-3"></div>
        </div>

        <!-- Step 4: Shop Approval -->
        <div class="test-section">
            <h3 class="step-indicator">Step 4: Shop Approves Confirmed Booking</h3>
            <p>Shop owner approves the confirmed booking.</p>
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Booking ID</label>
                    <input type="number" class="form-control" id="approveBookingId" placeholder="From Step 1">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="approveBooking()">Approve Booking</button>
            
            <div id="step4Result" class="mt-3"></div>
        </div>

        <!-- Step 5: View Booking Status -->
        <div class="test-section">
            <h3 class="step-indicator">Step 5: Check Booking Status</h3>
            <p>View all customer bookings to verify the workflow.</p>
            
            <button class="btn btn-info" onclick="viewCustomerBookings()">View My Bookings</button>
            <button class="btn btn-secondary ms-2" onclick="viewShopBookings()">View Shop Bookings</button>
            
            <div id="step5Result" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Set tomorrow's date as default
        document.getElementById('bookingDate').valueAsDate = new Date(Date.now() + 86400000);

        // Step 1: Create Booking
        document.getElementById('createBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('step1Result');
            resultDiv.innerHTML = '<div class="spinner-border"></div> Creating booking...';
            
            const formData = new FormData();
            formData.append('booking_data', JSON.stringify({
                shop_owner_id: parseInt(document.getElementById('shopOwnerId').value),
                service: document.getElementById('service').value,
                device_type: document.getElementById('deviceType').value,
                issue_description: document.getElementById('issueDescription').value,
                date: document.getElementById('bookingDate').value,
                time_slot: document.getElementById('timeSlot').value,
                description: 'Test booking from API tester'
            }));
            
            const photoFile = document.getElementById('devicePhoto').files[0];
            if (photoFile) {
                formData.append('device_photo', photoFile);
            }
            
            try {
                const response = await fetch('../frontend/customer/booking_create_v2.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úì Success!</h5>
                            <p><strong>Booking ID:</strong> ${data.booking_id}</p>
                            <p>${data.message}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                            <button class="btn btn-sm btn-primary mt-2" onclick="document.getElementById('diagBookingId').value=${data.booking_id}; document.getElementById('confirmBookingId').value=${data.booking_id}; document.getElementById('approveBookingId').value=${data.booking_id}">Auto-fill Booking ID Below</button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚úó Error</h5>
                            <p>${data.error}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        });

        // Step 2: Provide Diagnosis
        document.getElementById('diagnosisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('step2Result');
            resultDiv.innerHTML = '<div class="spinner-border"></div> Sending diagnosis...';
            
            try {
                const response = await fetch('../frontend/shop/booking_manage.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: parseInt(document.getElementById('diagBookingId').value),
                        action: 'diagnose',
                        diagnostic_notes: document.getElementById('diagnosticNotes').value,
                        estimated_cost: parseFloat(document.getElementById('estimatedCost').value),
                        estimated_time_days: parseInt(document.getElementById('estimatedDays').value)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úì Success!</h5>
                            <p>${data.message}</p>
                            <p>Customer will now see the quotation and can confirm or cancel.</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚úó Error</h5>
                            <p>${data.error}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        });

        // Step 3: Confirm Booking
        async function confirmBooking() {
            const bookingId = document.getElementById('confirmBookingId').value;
            const resultDiv = document.getElementById('step3Result');
            
            if (!bookingId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a Booking ID</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border"></div> Confirming booking...';
            
            try {
                const response = await fetch('../frontend/customer/booking_customer_confirm.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: parseInt(bookingId),
                        action: 'confirm'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úì Booking Confirmed!</h5>
                            <p>${data.message}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚úó Error</h5>
                            <p>${data.error}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Step 3: Cancel Booking
        async function cancelBooking() {
            const bookingId = document.getElementById('confirmBookingId').value;
            const reason = document.getElementById('cancelReason').value;
            const resultDiv = document.getElementById('step3Result');
            
            if (!bookingId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a Booking ID</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border"></div> Cancelling booking...';
            
            try {
                const response = await fetch('../frontend/customer/booking_customer_confirm.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: parseInt(bookingId),
                        action: 'cancel',
                        cancellation_reason: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>Booking Cancelled</h5>
                            <p>${data.message}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚úó Error</h5>
                            <p>${data.error}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Step 4: Approve Booking
        async function approveBooking() {
            const bookingId = document.getElementById('approveBookingId').value;
            const resultDiv = document.getElementById('step4Result');
            
            if (!bookingId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a Booking ID</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="spinner-border"></div> Approving booking...';
            
            try {
                const response = await fetch('../frontend/shop/booking_manage.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: parseInt(bookingId),
                        action: 'approve'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>‚úì Booking Approved!</h5>
                            <p>The booking is now approved and ready for technician assignment.</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚úó Error</h5>
                            <p>${data.error}</p>
                            <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Step 5: View Customer Bookings
        async function viewCustomerBookings() {
            const resultDiv = document.getElementById('step5Result');
            resultDiv.innerHTML = '<div class="spinner-border"></div> Loading bookings...';
            
            try {
                const response = await fetch('../frontend/customer/customer_bookings.php');
                const data = await response.json();
                
                if (data.success) {
                    const bookings = data.bookings || [];
                    let html = `
                        <div class="alert alert-info">
                            <h5>Customer Bookings (${bookings.length})</h5>
                            ${bookings.length === 0 ? '<p>No bookings found</p>' : ''}
                        </div>
                    `;
                    
                    bookings.forEach(b => {
                        html += `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>Booking #${b.id} - ${b.device_type}</h6>
                                    <p class="mb-1"><strong>Status:</strong> <span class="badge bg-primary">${b.status}</span></p>
                                    <p class="mb-1"><strong>Service:</strong> ${b.service}</p>
                                    <p class="mb-1"><strong>Issue:</strong> ${b.device_issue_description || 'N/A'}</p>
                                    ${b.diagnostic_notes ? `<p class="mb-1"><strong>Diagnosis:</strong> ${b.diagnostic_notes}</p>` : ''}
                                    ${b.estimated_cost ? `<p class="mb-1"><strong>Est. Cost:</strong> ‚Ç±${parseFloat(b.estimated_cost).toFixed(2)}</p>` : ''}
                                    ${b.estimated_time_days ? `<p class="mb-1"><strong>Est. Time:</strong> ${b.estimated_time_days} days</p>` : ''}
                                    <small class="text-muted">${b.date} ${b.time_slot}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Step 5: View Shop Bookings
        async function viewShopBookings() {
            const resultDiv = document.getElementById('step5Result');
            resultDiv.innerHTML = '<div class="spinner-border"></div> Loading shop bookings...';
            
            try {
                const response = await fetch('../frontend/shop/shop_bookings.php');
                const data = await response.json();
                
                if (data.success) {
                    const bookings = data.bookings || [];
                    let html = `
                        <div class="alert alert-warning">
                            <h5>Shop Bookings (${bookings.length})</h5>
                            ${bookings.length === 0 ? '<p>No bookings found</p>' : ''}
                        </div>
                    `;
                    
                    bookings.forEach(b => {
                        html += `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>Booking #${b.id} - ${b.customer_name}</h6>
                                    <p class="mb-1"><strong>Status:</strong> <span class="badge bg-warning">${b.status}</span></p>
                                    <p class="mb-1"><strong>Device:</strong> ${b.device_type || 'N/A'}</p>
                                    <p class="mb-1"><strong>Issue:</strong> ${b.device_issue_description || 'N/A'}</p>
                                    <p class="mb-1"><strong>Service:</strong> ${b.service}</p>
                                    <small class="text-muted">${b.date} ${b.time_slot}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>

